name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Get version from config.xml
      id: config_version
      run: |
        VERSION=$(grep -oP '(?<=<version>)[^<]+' config.xml)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "üì¶ Version in config.xml: $VERSION"

    - name: Get release tag version
      id: release_version
      run: |
        # Remove 'v' prefix if present (e.g., v3.0.0 -> 3.0.0)
        TAG_VERSION="${{ github.event.release.tag_name }}"
        TAG_VERSION="${TAG_VERSION#v}"
        echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
        echo "üè∑Ô∏è Release tag version: $TAG_VERSION"

    - name: Verify version match
      run: |
        CONFIG_VERSION="${{ steps.config_version.outputs.version }}"
        RELEASE_VERSION="${{ steps.release_version.outputs.version }}"
        
        echo "Comparing versions:"
        echo "  config.xml: $CONFIG_VERSION"
        echo "  Release tag: $RELEASE_VERSION"
        
        if [ "$CONFIG_VERSION" != "$RELEASE_VERSION" ]; then
          echo ""
          echo "‚ùå ERROR: Version mismatch!"
          echo "   config.xml has version '$CONFIG_VERSION'"
          echo "   Release tag is '$RELEASE_VERSION'"
          echo ""
          echo "Please update config.xml to version '$RELEASE_VERSION' before creating the release."
          exit 1
        fi
        
        echo ""
        echo "‚úÖ Versions match: $CONFIG_VERSION"

    - name: Create plugin directory
      run: |
        mkdir -p LimeSurveyWebhook
        cp LimeSurveyWebhook.php LimeSurveyWebhook/
        cp config.xml LimeSurveyWebhook/
        cp README.md LimeSurveyWebhook/

    - name: Create ZIP archive
      run: |
        VERSION="${{ steps.config_version.outputs.version }}"
        zip -r LimeSurveyWebhook-$VERSION.zip LimeSurveyWebhook/
        echo "üìÅ Created: LimeSurveyWebhook-$VERSION.zip"

    - name: Upload release asset
      uses: softprops/action-gh-release@v1
      with:
        files: LimeSurveyWebhook-${{ steps.config_version.outputs.version }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
